from core.scan_result import ScanResult
from core.http_interface import HTTPInterface
from core.owasp_flags import OWASP_FLAGS, ENDPOINT_FLAGS

def test_auth_mechanisms(api_client, endpoints, risk_level):
    results = []
    for endpoint in endpoints:
        if OWASP_FLAGS.BKEN_AUTH not in endpoint.get_flags():
            continue
        http_interface = HTTPInterface(api_client.get_url())
        response = http_interface.send_custom(endpoint.method, endpoint.path)
        if response.status_code < 400:
            scan_evidence = f"Method: {endpoint.method}\nPath: {endpoint.path}\nStatus: {response.status_code}"
            sr = ScanResult(
                2,
                OWASP_FLAGS.BKEN_AUTH.value,
                endpoint,
                risk_level,
                10,
                "Authentication mechanism weakness: endpoint does not return 401 status code",
                "Implement proper authentication mechanism",
                scan_evidence,
                "Authentication bypass",
                {}
            )
            results.append(sr)
    return results
