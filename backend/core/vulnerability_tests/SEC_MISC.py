from core.scan_result import ScanResult
from core.http_interface import HTTPInterface
from core.vulnerability_test import OWASP_FLAGS

def test_misconfig(api_client, endpoints, risk_level):
    print("Starting SEC MISC Test")
    results = []
    for endpoint in endpoints:
        if OWASP_FLAGS.SEC_MISC not in endpoint.get_flags():
            continue
        http_interface = HTTPInterface(api_client.get_url())
        response = http_interface.send_custom(endpoint.method, endpoint.path)
        if "Content-Security-Policy" not in response.headers:
            scan_evidence = f"Method: {endpoint.method}\nPath: {endpoint.path}\nHeader: Content-Security-Policy not found"
            sr = ScanResult(
                8,
                OWASP_FLAGS.SEC_MISC.value,
                endpoint,
                risk_level,
                6,
                "Security misconfiguration: Content-Security-Policy header not found",
                "Implement Content-Security-Policy header",
                scan_evidence,
                "Security misconfiguration",
                {}
            )
            results.append(sr)
    return results
