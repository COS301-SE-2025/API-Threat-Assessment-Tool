from core.scan_result import ScanResult
from core.http_interface import HTTPInterface
from core.owasp_flags import OWASP_FLAGS, ENDPOINT_FLAGS

def test_unsafe_consumption(api_client, endpoints, risk_level):
    print("Starting UCAPI Test")
    results = []
    for endpoint in endpoints:
        if OWASP_FLAGS.UCAPI not in endpoint.get_flags():
            continue
        http_interface = HTTPInterface(api_client.get_url())
        response = http_interface.send_custom(endpoint.method, endpoint.path)
        if response.status_code == 200:
            scan_evidence = f"Method: {endpoint.method}\nPath: {endpoint.path}\nStatus: {response.status_code}"
            sr = ScanResult(
                10,
                OWASP_FLAGS.UCAPI.value,
                endpoint,
                risk_level,
                8,
                "Unsafe consumption of APIs: endpoint consumes malicious API",
                "Validate and restrict API calls",
                scan_evidence,
                "API consumption vulnerability",
                {}
            )
            results.append(sr)
    return results
