from core.scan_result import ScanResult
from core.http_interface import HTTPInterface
from core.owasp_flags import OWASP_FLAGS, ENDPOINT_FLAGS

def test_resource_consumption(api_client, endpoints, risk_level):
    print("Starting URC Test")
    results = []
    for endpoint in endpoints:
        if OWASP_FLAGS.URC not in endpoint.get_flags():
            continue
        http_interface = HTTPInterface(api_client.get_url())
        for i in range(200):
            response = http_interface.send_custom(endpoint.method, endpoint.path)
            if response.status_code != 200:
                break
        if response.status_code != 429:
            scan_evidence = f"Method: {endpoint.method}\nPath: {endpoint.path}\nStatus: {response.status_code}"
            sr = ScanResult(
                4,
                OWASP_FLAGS.URC.value,
                endpoint,
                risk_level,
                8,
                "Unrestricted resource consumption vulnerability: rate limit exceeded",
                "Implement rate limiting",
                scan_evidence,
                "Rate limit exceeded",
                {}
            )
            results.append(sr)
    return results
