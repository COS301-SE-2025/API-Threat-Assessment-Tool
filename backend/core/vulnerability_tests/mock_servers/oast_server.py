# oast_server.py
from flask import Flask, request, jsonify
import uuid
from datetime import datetime

app = Flask(__name__)

INTERACTION_LOG = {}

@app.route('/log/<string:test_id>', methods=['GET', 'POST', 'PUT', 'PATCH', 'DELETE', 'HEAD', 'OPTIONS'])
def log_interaction(test_id):
    interaction_data = {
        'remote_ip': request.remote_addr,
        'headers': dict(request.headers),
        'method': request.method,
        'timestamp': datetime.utcnow().isoformat()
    }
    if test_id not in INTERACTION_LOG:
        INTERACTION_LOG[test_id] = []
    INTERACTION_LOG[test_id].append(interaction_data)
    print(f"âœ… Received interaction for test ID: {test_id}")
    return "OK", 200

@app.route('/poll/<string:test_id>', methods=['GET'])
def poll_for_interactions(test_id):
    interactions = INTERACTION_LOG.get(test_id, [])
    return jsonify(interactions)

if __name__ == '__main__':
    print("Starting OAST Collaborator Server on http://0.0.0.0:8001")
    app.run(host='0.0.0.0', port=8001)